{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">–ü–æ–¥–∞—Ç—å –ú–æ–¥—É–ª—å –Ω–∞ –ü—Ä–æ–≤–µ—Ä–∫—É</h1>

<form id="submission-form">
    <div class="mb-3">
        <label for="moduleFile" class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –º–æ–¥—É–ª—è (.py) üìå</label>
        <input class="form-control" type="file" id="moduleFile" required accept=".py">
        <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å.</div>
    </div>

    <div class="mb-3">
        <label for="moduleName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è (Class Name)</label>
        <input type="text" class="form-control" id="moduleName" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ModuarchMod">
    </div>

    <div class="mb-3">
        <label for="authorName" class="form-label">–ê–≤—Ç–æ—Ä –º–æ–¥—É–ª—è (–í–∞—à –Ω–∏–∫ –≤ Telegram)</label>
        <input type="text" class="form-control" id="authorName" required 
               value="{{ telegram_username|default('–£–∫–∞–∂–∏—Ç–µ –Ω–∏–∫') }}" 
               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: @MyAwesomeNick">
        <div class="form-text">–ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å.</div>
    </div>

    <div class="mb-3">
        <label for="moduleCommands" class="form-label">–ö–æ–º–∞–Ω–¥—ã –º–æ–¥—É–ª—è (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑)</label>
        <textarea class="form-control" id="moduleCommands" rows="5" required
                  placeholder="–ö–æ–º–∞–Ω–¥—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏—Ö."></textarea>
        <div id="commands-feedback" class="form-text"></div>
    </div>

    <div class="mb-3">
        <label for="moduleDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è</label>
        <textarea class="form-control" id="moduleDescription" rows="3" required
                  placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –≤–∞—à –º–æ–¥—É–ª—å."></textarea>
    </div>
    
    <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn btn-success" id="submit-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
</form>

<div id="alert-container" class="mt-4"></div>

{% endblock %}

{% block scripts %}
<script>
    document.getElementById('moduleFile').addEventListener('change', analyzeCode);

    async function analyzeCode(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const code = e.target.result;
            const feedback = document.getElementById('commands-feedback');
            const commandsArea = document.getElementById('moduleCommands');
            
            feedback.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ Gemini API...';
            commandsArea.value = '';

            try {
                // –í—ã–∑–æ–≤ API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                const response = await fetch('{{ url_for("analyze_module_code") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const result = await response.json();

                if (result.success) {
                    commandsArea.value = result.commands;
                    feedback.textContent = '‚úÖ –ö–æ–º–∞–Ω–¥—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.';
                    feedback.className = 'form-text text-success';
                } else {
                    commandsArea.value = result.commands; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ Gemini –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
                    feedback.textContent = result.commands || '‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞.';
                    feedback.className = 'form-text text-danger';
                }
            } catch (error) {
                feedback.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º API.';
                feedback.className = 'form-text text-danger';
            }
        };
        reader.readAsText(file);
    }
    
    document.getElementById('submission-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('moduleCommands').value; 
        const fileInput = document.getElementById('moduleFile');
        const file = fileInput.files[0];
        let moduleCodeText = '';

        if (!file) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª –º–æ–¥—É–ª—è.');
            return;
        }

        const reader = new FileReader();
        reader.onload = async (e) => {
            moduleCodeText = e.target.result;

            const submissionData = {
                name: document.getElementById('moduleName').value,
                author: document.getElementById('authorName').value,
                commands: document.getElementById('moduleCommands').value,
                description: document.getElementById('moduleDescription').value,
                module_code: moduleCodeText
            };

            document.getElementById('submit-btn').disabled = true;

            // –í—ã–∑–æ–≤ API –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–æ–¥—É–ª—è
            const response = await fetch('{{ url_for("submit_module_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(submissionData)
            });

            const result = await response.json();
            document.getElementById('submit-btn').disabled = false;
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${result.success ? 'alert-success' : 'alert-danger'}`;
            alertDiv.textContent = result.message;
            document.getElementById('alert-container').innerHTML = '';
            document.getElementById('alert-container').appendChild(alertDiv);
            
            if (result.success) {
                 // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                 setTimeout(() => window.location.href = '{{ url_for("modules_list") }}', 2000);
            }
        };
        reader.readAsText(file);
    });
</script>
{% endblock %}
