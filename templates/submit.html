{% extends "base.html" %}

{% block content %}
    <h1>Выставь модуль!</h1>
    
    <div class="form-container">
        <form id="moduleSubmitForm" class="submit-form">
            
            <div class="form-step">
                <label>1. ПРИКРЕПИ МОДУЛЬ (код)</label>
                <textarea id="module_code" name="module_code" placeholder="Вставьте сюда код вашего модуля..." rows="10" required></textarea>
                <button type="button" class="btn neon-btn btn-secondary" onclick="analyzeCode()">
                    <span class="material-icons" style="vertical-align: middle;">code</span> АНАЛИЗИРОВАТЬ КОМАНДЫ
                </button>
            </div>

            <div class="form-step">
                <label for="name">2. НАЗВАНИЕ:</label>
                <input type="text" id="name" name="name" required>
            </div>
            
            <div class="form-step">
                <label for="commands">3. КОМАНДЫ:</label>
                <textarea id="commands" name="commands" rows="5" placeholder="например: .stop - останавливает Heroku. (Будет автоматически заполнено после анализа)" required></textarea>
            </div>

            <div class="form-step">
                <label for="description">4. ОПИСАНИЕ:</label>
                <textarea id="description" name="description" rows="5" required></textarea>
            </div>
            
            <div class="form-step">
                <label>5. ПОСТАВЬ БАННЕР (URL)</label>
                <input type="text" id="banner_url" name="banner_url" placeholder="URL изображения для баннера">
                <button type="button" class="btn neon-btn btn-secondary" onclick="alert('TODO: Загрузка изображения')">
                    <span class="material-icons" style="vertical-align: middle;">image</span> НАЖМИ (Загрузить файл)
                </button>
            </div>
            
            <input type="hidden" id="author" name="author" value="{{ telegram_username }}">

            <button type="submit" class="btn neon-btn" style="align-self: flex-end; font-size: 1.5em; padding: 15px 30px;">
                ОПУБЛИКОВАТЬ
            </button>
        </form>

        <p id="message" style="margin-top: 20px; text-align: center; color: var(--color-cyan);"></p>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Функция для анализа кода через API
    function analyzeCode() {
        const code = document.getElementById('module_code').value;
        const commandsArea = document.getElementById('commands');
        commandsArea.value = 'Анализ...';

        fetch('{{ url_for("analyze_module_code") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                commandsArea.value = data.commands;
            } else {
                commandsArea.value = data.commands || 'Ошибка анализа.';
            }
        })
        .catch(error => {
            commandsArea.value = 'Ошибка: ' + error.message;
        });
    }

    // Функция для отправки формы через API
    document.getElementById('moduleSubmitForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const messageElement = document.getElementById('message');

        messageElement.textContent = 'Отправка на модерацию...';
        
        // Добавляем заглушку, так как загрузка файлов сложна, а в API у нас просто текстовые поля.
        data.module_code = document.getElementById('module_code').value;
        data.banner_url = document.getElementById('banner_url').value;

        fetch('{{ url_for("submit_module_api") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            messageElement.textContent = data.message;
            if (data.success) {
                form.reset(); // Очистить форму после успешной отправки
            }
        })
        .catch(error => {
            messageElement.textContent = 'Ошибка отправки: ' + error.message;
        });
    });
</script>
{% endblock %}
