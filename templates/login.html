{% extends "base.html" %}

{% block content %}
    <div class="login-box">
        <h1>ВХОД / РЕГИСТРАЦИЯ</h1>
        <p class="text-subtle">Используйте Google для безопасного входа.</p>
        
        <button id="signInButton" class="btn neon-btn" style="background-color: #DB4437; box-shadow: 0 0 10px #DB4437; margin-top: 20px;">
            <span class="material-icons" style="vertical-align: middle;">login</span> ВОЙТИ ЧЕРЕЗ GOOGLE
        </button>
        
        <p id="authMessage" style="margin-top: 20px; color: var(--color-cyan);"></p>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    // 2. ВАША КОНФИГУРАЦИЯ FIREBASE (замените на свои ключи!)
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // 3. Инициализация Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    const messageElement = document.getElementById('authMessage');

    // 4. Логика входа
    document.getElementById('signInButton').addEventListener('click', () => {
        messageElement.textContent = 'Ожидание авторизации...';
        
        auth.signInWithPopup(googleProvider)
            .then((result) => {
                // Получение ID-токена
                return result.user.getIdToken();
            })
            .then((idToken) => {
                // Отправка токена на Flask API для установки сессии
                return fetch('{{ url_for("auth_api") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken: idToken })
                });
            })
            .then(response => response.json())
            .then(data => {
                messageElement.textContent = data.message;
                if (data.success && data.redirect) {
                    window.location.href = data.redirect; // Перенаправление на страницу аккаунта
                }
            })
            .catch((error) => {
                messageElement.textContent = `Ошибка входа: ${error.message}`;
            });
    });
</script>
{% endblock %}
