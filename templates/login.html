{% extends "base.html" %}

{% block content %}
    <div class="login-box">
        <h1>ВХОД / РЕГИСТРАЦИЯ</h1>
        <p class="text-subtle">Используйте ваш Email и Пароль.</p>
        
        <form id="loginForm" style="margin-top: 20px;">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Пароль" required>
            
            <button type="submit" class="btn neon-btn" style="background-color: var(--color-violet); margin-top: 10px;">
                <span class="material-icons" style="vertical-align: middle;">login</span> ВОЙТИ
            </button>
            <button type="button" id="registerButton" class="btn neon-btn btn-secondary" style="margin-top: 10px;">
                <span class="material-icons" style="vertical-align: middle;">person_add</span> РЕГИСТРАЦИЯ
            </button>
        </form>
        
        <p id="authMessage" style="margin-top: 20px; color: var(--color-cyan);"></p>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    // 2. ВАША КОНФИГУРАЦИЯ FIREBASE (замените на свои ключи!)
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        // ... остальные ключи
    };

    // 3. Инициализация Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const messageElement = document.getElementById('authMessage');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    // Общая функция для отправки токена на сервер
    function sendTokenToServer(user) {
        user.getIdToken().then(idToken => {
            fetch('{{ url_for("auth_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken: idToken })
            })
            .then(response => response.json())
            .then(data => {
                messageElement.textContent = data.message;
                if (data.success && data.redirect) {
                    window.location.href = data.redirect;
                }
            })
            .catch(error => {
                messageElement.textContent = `Ошибка сервера: ${error.message}`;
            });
        });
    }

    // 4. Логика входа
    document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        messageElement.textContent = 'Выполняется вход...';
        
        auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
            .then((userCredential) => {
                // Успешный вход
                sendTokenToServer(userCredential.user);
            })
            .catch((error) => {
                messageElement.textContent = `Ошибка входа: ${error.message}`;
            });
    });

    // 5. Логика регистрации
    document.getElementById('registerButton').addEventListener('click', () => {
        messageElement.textContent = 'Выполняется регистрация...';
        
        auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
            .then((userCredential) => {
                // Успешная регистрация
                messageElement.textContent = 'Регистрация успешна! Входим...';
                sendTokenToServer(userCredential.user);
            })
            .catch((error) => {
                messageElement.textContent = `Ошибка регистрации: ${error.message}`;
            });
    });

</script>
{% endblock %}
